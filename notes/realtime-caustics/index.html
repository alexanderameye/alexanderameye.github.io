<!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="A tutorial (with code included) on how to render realtime caustics in Unity using Shader Graph. The solution uses the depth buffer to create world-space mapped UVs and render the caustics in a volume using a custom pass. Multiple panning textures are used for the caustics. Works with Unity&#39;s Universal Render Pipeline (URP)."><meta name="author" content="Alexander Ameye"><meta name="google" content="notranslate"><meta name="generator" content="eleventy"><meta property="og:title" content="Rendering realtime caustics"><meta property="og:description" content="ðŸŒˆ A tutorial (with code included) on how to render realtime caustics in Unity using Shader Graph. The solution uses the depth buffer to create world-space mapped UVs and render the caustics in a volume using a custom pass. Multiple panning textures are used for the caustics. Works with Unity&#39;s Universal Render Pipeline (URP)."><meta property="og:type" content="article"><meta property="og:image" content="https://alexanderameye.github.io/notes/realtime-caustics/cover.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="675"><meta name="twitter:title" content="Rendering realtime caustics"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@alexanderameye"><meta name="twitter:description" content="A tutorial (with code included) on how to render realtime caustics in Unity using Shader Graph. The solution uses the depth buffer to create world-space mapped UVs and render the caustics in a volume using a custom pass. Multiple panning textures are used for the caustics. Works with Unity&#39;s Universal Render Pipeline (URP)."><meta name="twitter:image" content="https://alexanderameye.github.io/notes/realtime-caustics/cover.png"><meta name="twitter:creator" content="@alexanderameye"><title>Rendering realtime caustics</title><link rel="preload" href="/assets/css/reset.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/assets/css/reset.css"></noscript><style>body,html{background-color:var(--palette-offwhite-100);margin:0;padding:0;scroll-behavior:smooth;border:none;color:var(--palette-offgray-600)}::selection{background-color:#e0e0e0}.fade-in{animation:fade-in .2s cubic-bezier(.165,.84,.44,1) both}@keyframes fade-in{0%{opacity:0}100%{opacity:1}}.note .note-content h1{text-align:center;margin-top:20px;margin-bottom:15px;font-size:2em}.column-page-content h1{display:block;font-size:1.5em;margin-top:40px;margin-bottom:15px;margin-inline-start:0;margin-inline-end:0;font-weight:700}.note-entry .note-entry-header h2{margin:0;font-size:16px;padding-top:0;display:block;font-weight:700}.column-page-content h2{display:block;font-size:1.5em;margin-top:40px;margin-bottom:15px;margin-inline-start:0;margin-inline-end:0;font-weight:700}.note-content h3{margin-top:40px;margin-bottom:15px}.note-content h4{margin-top:40px;margin-bottom:5px;font-size:15px}p{-webkit-hyphens:auto;-ms-hyphens:auto;-moz-hyphens:auto;hyphens:auto}.column-page-content p{margin-bottom:10px;padding:0;font-family:Inconsolata,monospace;text-align:justify;font-style:normal;font-size:16px;letter-spacing:.02em;line-height:1.6em;overflow-wrap:break-word}.column-page-content p a{text-decoration:none;border-bottom:2px dotted #000;opacity:1;color:#000}.column-page-content p a:hover{background-color:var(--link-hover-color);color:#fff;transition:color .2s ease;font-weight:700;opacity:1}.column-page-content{grid-area:content;position:relative}.note-title{line-height:1.3em}.note-subtitle{text-align:center;font-size:medium}.note-subtitle p{text-align:center}.reading-time{font-family:Inconsolata,monospace;font-weight:400}.katex-display .katex{padding-top:10px;padding-bottom:10px;border:2px dashed #cacaca;border-radius:5px}.katex-display>.katex{white-space:nowrap;text-align:initial}.katex{line-height:1.2;white-space:normal;text-indent:0}blockquote{box-sizing:border-box;font-style:italic;color:#494949;background-color:#fff8eb80;border-color:#000;border-radius:4px;border-width:2px;border-style:solid;margin-top:15px;margin-bottom:15px;padding:8px 16px}blockquote ul{padding-bottom:0}blockquote ol{padding-top:0;padding-bottom:0;margin:0}.column-page-content blockquote p{margin:0;text-align:left}blockquote a{text-decoration:none;border-bottom:2px dotted #000;opacity:1;color:#000}blockquote a:hover{background-color:var(--link-hover-color);color:#fff;transition:color .2s ease;font-weight:700;opacity:1}.column-page-content blockquote:hover{outline-offset:0;animation:pulse 1s ease-out infinite forwards;z-index:1000}@keyframes pulse{0%{outline-offset:0;outline:solid 4px rgba(160,160,160,.5)}100%{outline-offset:8px;outline:solid 2px rgb(255,255,255,0)}}.note-date{margin-top:50px;padding-bottom:0;margin-bottom:0;font-size:smaller;font-family:arial-rounded-bold}.note-comments{grid-area:comments;background-color:var(--base-color);margin-top:20px}.note-footer{grid-area:footer;background-color:var(--base-color);border-top:2px dashed #000;margin-top:20px;padding-top:.8rem;display:flex;align-items:flex-start;justify-content:space-between}.footer{grid-area:footer;background-color:var(--base-color);border-top:2px dashed #000;margin-top:20px;padding-top:.8rem}.footer p{font-family:Inconsolata,monospace;line-height:1.6em}.footer p a{text-decoration:none;border-bottom:2px dotted #000;opacity:1;color:#000}.footer p a:hover{background-color:var(--link-hover-color);color:#fff;transition:color .2s ease;font-weight:700;opacity:1}.project-tags{padding:0;margin-bottom:10px;display:flex;justify-content:flex-start;align-items:flex-start;flex-wrap:wrap}.note-tags{padding:0;display:flex;justify-content:flex-start;align-items:flex-start;flex-wrap:wrap}.note-tags a{display:block;padding-inline-start:10px;padding-inline-end:10px;font-size:14px;line-height:30px;text-decoration:none;background-color:#fffefc80;border:2px solid var(--palette-offgray-600);color:var(--palette-offgray-600);border-radius:10px;transition:transform .1s;font-family:arial-rounded-bold;box-shadow:1px 1px}.note-tags a:before{content:"#";margin-right:.25rem}.note-tags a:hover{transform:scale(1.05)}.note-tags sup{font-size:xx-small;vertical-align:super}.tags-header .note-tags li{padding-right:0}.note-tags li{display:inline-block;padding-right:10px;padding-bottom:5px;padding-top:5px}.tag{display:inline-block;padding:.25rem .75rem;margin:1rem .5rem 0 0;font-size:1rem;font-family:Inter,sans-serif;line-height:130%;border-radius:.5rem;text-decoration:none;position:relative;top:0;transition:.35s}.menu ul{list-style-type:none;margin-right:20px;margin-left:20px;padding:0}ul{padding-inline-start:20px;padding-bottom:10px;margin-block-start:0px;margin-block-end:0px}.menu ul li{text-align:right;font-family:Inter,serif;font-size:1.2em;padding-top:10px;padding-bottom:10px}.menu{text-align:right;display:none;position:absolute;background-color:var(--base-color);box-shadow:-10px 0 30px -15px #0000002b;right:0;position:fixed;z-index:499;top:65px;bottom:0}.menu a{text-decoration:none;color:#000}#toggle{display:none}#toggle:checked+#menu{display:flex}.sticky{position:-webkit-sticky;position:sticky;z-index:2}#navbar-desktop{background-color:var(--palette-offwhite-100);display:flex;flex-wrap:wrap;align-items:center;justify-content:space-around;z-index:500;position:fixed;top:0;left:0;width:100%}#navbar-desktop[stuck]{opacity:0;transition:opacity 1s,transform 1.3s}#navbar-mobile{background-color:var(--base-color);display:flex;flex-wrap:wrap;align-items:center;justify-content:space-around;z-index:500;position:fixed;top:0;left:0;width:100%}.navigation{flex:1}.navigation ul{justify-content:space-between;display:flex;list-style-type:none;margin:0;padding:0}.navigation ul a{text-decoration:none;display:flex;color:#000}.small-font{font-size:small}.large-font{font-size:large}.column-page{margin-top:52px;padding-bottom:50px;display:grid;grid-template-areas:"left content right""left footer right""left comments right"}.wide-column-page{background-color:var(--base-color);padding-bottom:50px;display:grid;grid-template-areas:"left content right""left footer right""left comments right"}.wide-column-page-content{background-color:var(--base-color);grid-area:content;text-align:justify;position:relative}.notes-list{text-align:right;grid-area:left;list-style-position:inside;list-style:none;margin:0;padding:0}.notes-list-link{text-align:right}.notes-list-link a{text-decoration:none;color:inherit}.notes-list-link a:hover{font-weight:700;font-style:normal}h3 span{font-weight:400}.note-content .download-button{display:inline-block;padding:.25rem .5rem;border-radius:0;border:2px dashed #000;font-size:smaller}.download-button{display:inline-block;padding:.25rem .5rem;border-radius:0;border:2px dashed #000;font-size:smaller;text-decoration:none;color:inherit}.download-button:hover{background-color:var(--link-hover-color);color:#fff;transition:color .2s ease;font-weight:700;opacity:1}.menu li .resume-button{text-decoration:none;color:#fff;background-color:#000;border-radius:5px;line-height:1em;padding:8px 0 8px 10px;align-items:center;font-size:small;z-index:400}.portfolio-button{text-decoration:none;color:#fff;background-color:#000;border-radius:5px;line-height:1em;margin-right:10px;padding:4px 0 4px 10px;align-items:center;font-size:small;display:flex}.portfolio-icon{margin-left:3px;margin-right:4px}[class*=" icon-"].portfolio-icon::before,[class^=icon-].portfolio-icon::before{font-size:16px}[class*=" icon-"].tags-icon::before,[class^=icon-].tags-icon::before{font-size:16px}.navbar-icon{color:#000;margin-left:5px;margin-right:5px}.anchor-link{text-decoration:none}.anchor-symbol{color:#cecece}.anchor-symbol:hover{color:#000;transition:color .2s ease;font-weight:700;opacity:1}.screen-reader-only{border:0;clip:rect(0 0 0 0);height:1px;margin:-1px;overflow:hidden;padding:0;position:absolute;width:1px}figcaption{font-family:Inconsolata,monospace;font-style:normal;font-weight:700;font-size:13px;letter-spacing:.02em;line-height:1.6em;color:rgba(53,53,53,.8)}.images-row{display:flex;margin:20px -5px}.images-row picture{margin:0 5px}.images-row figure picture{margin:0}.images-row figure{margin:0 5px 0 5px}.images-row img{display:inline-block;max-width:100%;width:auto;height:100%;border-radius:var(--image-border-radius)}li{margin:0;padding:0;font-family:Inconsolata,monospace;text-align:justify;font-style:normal;font-size:16px;letter-spacing:.02em;line-height:1.6em}p img{max-width:100%;border-radius:var(--image-border-radius);display:block;margin-left:auto;margin-right:auto;border-style:none;margin:1.25em 0}p img[width][height]{height:100%}figure img[width][height]{height:100%}.note-video{display:block;margin-left:auto;margin-right:auto;margin-top:30px;margin-bottom:30px}.blob-num{border-right:1px solid #ddd}.gist-meta a{color:#3b5998!important;font-weight:700;text-decoration:none}.gist-meta a:hover{text-decoration:underline!important}.hover-highlight::before{content:"";position:absolute;width:100%;height:100%;top:0;left:0;z-index:-1;border-radius:var(--marker-roundness);background-image:linear-gradient(104deg,rgba(0,0,0,0) .9%,rgba(var(--highlighter-color),1.25) 2.4%,rgba(var(--highlighter-color),.5) 5.8%,rgba(var(--highlighter-color),.25) 93%,rgba(var(--highlighter-color),.7) 96%,rgba(0,0,0,0) 98%),linear-gradient(183deg,rgba(0,0,0,0) 0,rgba(var(--highlighter-color),.3) 7.9%,rgba(0,0,0,0) 15%);transform:rotate(-5deg);-webkit-box-decoration-break:clone;box-decoration-break:clone;background-size:0 100%;background-repeat:no-repeat;transition:.3s}.hover-highlight{position:relative;overflow:hidden;padding:.1em 15px}.hover-highlight:hover:before{background-size:100% 100%}.navbar-element-active.hover-highlight:before{background-size:100% 100%}mark{background-color:mark;color:marktext;padding:.1em 5px;margin-right:-5px;margin-left:-5px;border-radius:var(--marker-roundness);-webkit-box-decoration-break:clone;box-decoration-break:clone;background:linear-gradient(104deg,rgba(0,0,0,0) .9%,rgba(var(--marker-color),1.25) 2.4%,rgba(var(--marker-color),.5) 5.8%,rgba(var(--marker-color),.25) 93%,rgba(var(--marker-color),.7) 96%,rgba(0,0,0,0) 98%),linear-gradient(183deg,rgba(0,0,0,0) 0,rgba(var(--marker-color),.3) 7.9%,rgba(0,0,0,0) 15%)}figure{display:block;margin-left:auto;margin-right:auto;margin-top:30px;margin-bottom:30px}picture{display:flex;justify-content:center;margin:0}figcaption{display:flex;justify-content:center}#profile-picture{width:50px;height:50px;border-radius:9999px}.navbar-nav{padding:5px}#navbar-mobile .navbar-nav a{margin-left:0;margin-right:0}.navbar-nav>.active{color:#282828;font-weight:700}.navbar-element{font-size:large;color:#1b1b1b;text-decoration:none;font-family:arial-rounded-bold;margin-left:1rem;margin-right:1rem}.navbar-element:hover{color:var(--navbar-element-color)}.navbar-element-active{color:var(--navbar-element-color)}summary{list-style:none;border:2px solid #000;padding:.75em 1em;border-radius:0;cursor:pointer;position:relative;padding-left:calc(1.75rem + .75rem + .75rem)}summary:before{position:absolute;top:50%;transform:translateY(-50%);left:.75rem;content:"â†“";width:1.75rem;height:1.75rem;background-color:#000;color:#fff;display:inline-flex;justify-content:center;align-items:center;flex-shrink:0}details[open] summary{background-color:#e7e7e7}details[open] summary:before{content:"â†‘"}details div{border-left:2px solid #000;border-right:2px solid #000;border-bottom:2px solid #000;padding:1em}details{margin-top:10px;margin-bottom:10px}summary:hover{background-color:#e7e7e7}.footer-links a{padding:.3rem;display:flex;align-items:center;justify-content:center;color:#000;background-color:#fcfcfa;border-radius:8px;border:2px solid #000;box-shadow:2px 2px;width:2rem;height:2rem;line-height:2rem}.footer-links a:hover{transform:scale(1.05)}@font-face{font-family:icons;src:url('/assets/fonts/icons.woff2?fokozo') format('woff2'),url('/assets/fonts/icons.woff?fokozo') format('woff'),url('/assets/fonts/icons.svg?fokozo#icons') format('svg');font-weight:400;font-style:normal;font-display:swap}[class*=" icon-"]:before,[class^=icon-]:before{font-family:icons!important;font-style:normal;font-weight:400;display:inline-block;text-decoration:inherit;font-size:24px;width:1em;margin-right:.2em;text-align:center;font-variant:normal;text-transform:none;line-height:1em;margin-left:.2em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.icon-arrow-up:before{content:"\ea3a";margin-top:8px}.icon-rss:before{content:"\ea9b";margin-top:8px}@media only screen and (max-device-width:3840px){#navbar-mobile{display:none}#back-to-top-mobile{display:none}p img[width]{width:50%}figure img[width]{width:50%}}@media only screen and (max-device-width:576px){#navbar-mobile{display:flex}#navbar-desktop{display:none}#back-to-top-mobile{display:block}#back-to-top-desktop{display:none}p img[width]{width:100%}figure img[width]{width:100%}video[width]{width:100%}}@media (min-width:350px){.column-page,.note{grid-template-columns:auto 340px auto}.wide-column-page{grid-template-columns:auto 340px auto}}@media (min-width:450px){.column-page,.note{grid-template-columns:auto 400px auto}.wide-column-page{grid-template-columns:auto 400px auto}}@media (min-width:576px){.column-page,.note{grid-template-columns:auto 500px auto}.wide-column-page{grid-template-columns:auto 500px auto}}@media (min-width:768px){.column-page,.note{grid-template-columns:auto 500px auto}.wide-column-page{grid-template-columns:auto 750px auto}}@media (min-width:992px){.column-page,.note{grid-template-columns:auto 700px auto}.wide-column-page{grid-template-columns:auto 900px auto}}@media (min-width:1200px){.column-page,.note{grid-template-columns:auto 700px auto}.wide-column-page{grid-template-columns:auto 1150px auto}}@media (min-width:1400px){.column-page,.note{grid-template-columns:auto 700px auto}.wide-column-page{grid-template-columns:auto 1350px auto}}.timeline{margin-top:40px;margin-bottom:40px}.timeline-list{position:relative;padding-left:45px;list-style:none}.timeline-event p{position:relative;top:-5px;margin:0;text-align:left}.timeline-event .year{font-size:small;padding:0;margin:0;font-weight:700;color:#6e6e6e}.timeline-event{position:relative}.timeline-event.is-not-done{padding-bottom:30px}.timeline-event.is-done{padding-bottom:15px}.timeline-event:before{display:inline-block;content:'';position:absolute;left:-37px;height:100%;width:10px}.timeline-event::after{content:'';display:inline-block;position:absolute;top:0;left:-44px;width:12px;height:12px;border:2px solid #000;border-radius:50%;background-color:#fff}.timeline-event.is-not-done::before{border-left:3px dotted #000}.timeline-event.is-done:not(:last-child)::before{border-left:3px solid #000}.timeline-event.is-done::after{font-size:10px;border:2px solid #000;background-color:#000}.left-section{margin-top:122px;float:left;width:50%;min-height:100%;display:flex;flex-direction:column;background-color:var(--base-color);position:fixed}.left-section-content{display:flex;flex-direction:column;align-items:center;justify-content:center}.left-section-content img{padding-top:15px;padding-bottom:15px}body,html{height:100%;margin:0}.right-section{margin-top:82px;float:right;width:50%;min-height:100%;background-color:var(--base-color)}.right-section .column-page-content{padding-left:15%;padding-right:15%}.projects-container{display:flex;flex-wrap:wrap;justify-content:space-between;gap:1em}.projects-column{flex:1 1 30%;max-width:30%;box-sizing:border-box;padding:10px 0}.projects-media-wrapper{position:relative;overflow:hidden;margin-bottom:1em;margin-top:2em;border-radius:4px}.projects-media-wrapper a{display:block}.projects-media-wrapper img{width:100%;height:auto;transition:transform .5s ease;border-radius:4px}.projects-media-wrapper video{width:100%;height:auto;transition:transform .5s ease;border-radius:4px}.projects-media-wrapper:hover{outline-offset:0;animation:pulse 1s ease-out infinite forwards;z-index:1000}.projects-label{color:#000;font-family:monospace;font-size:.8rem;padding:.4em 0 0 0;text-align:left}@media (max-width:900px){.projects-column{flex:1 1 45%;max-width:45%}}@media (max-width:600px){.projects-column{flex:1 1 100%;max-width:100%}}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}.status-container{display:flex;margin:0;padding:0;flex-direction:row;align-items:flex-start;grid-column-gap:10px}.status-ring{border:3px solid #2dc504;-webkit-border-radius:30px;height:10px;width:10px;padding:0;margin-left:-5px;margin-top:-5px;-webkit-animation:pulsate 1s ease-out;-webkit-animation-iteration-count:infinite;opacity:0}.status-dot{width:6px;height:6px;background-color:#2dc504;border-radius:50%;opacity:1;margin-top:10px}@-webkit-keyframes pulsate{0%{-webkit-transform:scale(.1,.1);opacity:0}50%{opacity:1}100%{-webkit-transform:scale(1.2,1.2);opacity:0}}.px-50{padding-left:.5rem;padding-right:.5rem}.px-75{padding-left:.75rem;padding-right:.75rem}.px-150{padding-left:1.5rem;padding-right:1.5rem}.py-50{padding-top:.5rem;padding-bottom:.5rem}.py-75{padding-top:.75rem;padding-bottom:.75rem}.py-100{padding-top:1rem;padding-bottom:1rem}.rounded-25{border-radius:.25rem}.c-gray{color:#282828}.bg-gray-hover:hover{background:#f4f4f4}.no-underline{text-decoration:none}.align-right{text-align:right;list-style-position:inside}.note-entry-content h3{padding-bottom:0}.project-entry-content h3{padding-bottom:0}.note-content iframe{padding:0;margin:0;width:100%;display:block}@font-face{font-family:arial-rounded-regular;src:url('/assets/fonts/arial-rounded.woff2') format('woff2'),url('/assets/fonts/arial-rounded.woff') format('woff');font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:arial-rounded-bold;src:url('/assets/fonts/arial-rounded-bold.woff2') format('woff2'),url('/assets/fonts/arial-rounded-bold.woff') format('woff');font-weight:400;font-style:normal;font-display:swap}.projects{margin:0 auto;display:grid;grid-gap:1rem;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}.project-entry{position:relative;background:#fff;border-radius:10px;transition:transform .2s;border:1px solid #f0f0f0}.project-entry-image{border-radius:10px 10px 0 0;height:100px;object-fit:cover;width:100%}.project-entry:active{transform:scale(.95)}.project-entry-content{padding:15px}.project-entry-description{margin:8px 0;color:var(--gray);font-size:14px;line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2}.project-entry-footer{color:var(--gray);font-size:12px}.project-entry-link{position:absolute;left:0;right:0;top:0;bottom:0}.project-image{border-radius:10px}.action-buttons{display:flex;justify-content:space-evenly}.action-button-link{position:absolute;left:0;right:0;top:0;bottom:0}.action-button:hover{transform:scale(1.02)}.column-page-content .action-button p{text-align:center;margin:0}.action-button{max-width:fit-content;width:100%;display:block;font-size:14px;line-height:30px;color:#fff;text-decoration:none;background:#000;border-radius:10px;transition:transform .1s;position:relative;padding:12px;margin-bottom:20px}.devlog-entry{max-width:740px;margin:6rem auto;padding:2rem;padding-left:280px;clear:both;display:flex;flex-direction:column;position:relative;text-decoration:none}.devlog-entry-link{position:absolute;top:0;bottom:0;left:0;right:inherit}.devlog-entry-title h2{padding-top:0;padding-bottom:5px;font-weight:bolder}.devlog-entry-body{display:flex;flex-direction:column;padding:2rem}.devlog-entry-body .devlog-entry-description{margin-bottom:10px;padding:0;font-family:Inconsolata,monospace;text-align:justify;font-style:normal;font-size:16px;letter-spacing:.02em;line-height:1.6em}.devlog-entry-image{box-shadow:0 0 0 rgb(50 115 235 / 0%);border-radius:8px;position:absolute;left:0;top:0;bottom:0;width:280px;overflow:hidden;transition:all .2s ease}.devlog-entry-image img{width:100%;height:100%;max-width:100%;max-height:100%;object-fit:cover;object-position:center}.devlog-entry:active{transform:scale(.95)}.note-entry{border-radius:8px;border:3px solid var(--palette-offgray-600);overflow:hidden;margin-bottom:20px;position:relative;color:var(--palette-offgray-600)}.note-entry-grid{display:grid;grid-template-columns:60% 40%;grid-gap:0px;background:#fffF;background-color:#fffefc80}.note-entry-header{display:flex;flex-direction:row;align-items:flex-start}.note-entry-header h3{margin:0;font-size:16px;padding-top:0}.note-entry-header span{padding-right:5px}.note-entry-description{color:#000;line-height:1.6;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2}.note-entry-description p{margin:0;font-family:Inconsolata,monospace;text-align:left;font-style:normal;font-size:16px;line-height:1.4em}.note-entry-footer{color:#000;font-size:smaller;font-family:arial-rounded-bold}.note-entry-main{padding:14px;display:flex;flex-direction:column;align-items:flex-start;justify-content:space-between}.project-page-image img{width:100%;height:300px;display:block;object-fit:cover}.note-entry-image{padding:0;position:relative;grid-column:2;max-height:100%;max-width:100%;clip-path:polygon(10% 0%,100% 0%,100% 100%,0% 100%)}.note-entry-image img{width:100%;height:140px;display:block;object-fit:cover}.note-entry-link{position:absolute;left:0;right:0;top:0;bottom:0}.bold{font-weight:700}.tags-header{display:flex;align-items:center;padding-top:0;padding-bottom:0;margin-bottom:20px;margin-top:40px;justify-content:space-between}.tags-header h2{padding:0;margin:0;text-align:left}.tags-header h1{padding:0;margin:0;text-align:left}.home-header{display:flex;align-items:start;padding-top:40px;padding-bottom:0;grid-row-gap:15px;flex-direction:column}.home-header-me{display:flex;align-items:start;padding-top:40px;padding-bottom:0;grid-column-gap:15px;flex-direction:row;padding:0}.home-header h2{padding:0;margin:0;text-align:left}.home-header img{border-radius:4px;object-fit:cover;max-width:120px}.home-header blockquote{margin:0}.home-header blockquote ul{list-style-type:none;padding:0}.back-to-top-mobile{position:absolute;top:116vh;right:0;bottom:0}.back-to-top-mobile a{padding:.3rem;position:-webkit-sticky;position:sticky;top:90vh;display:flex;align-items:center;justify-content:center;color:#000;background-color:#fff;border-radius:8px;border:2px solid #000;box-shadow:2px 2px;width:2rem;height:2rem;line-height:2rem}.back-to-top-desktop{position:absolute;top:120vh;bottom:0;right:-100px}.back-to-top-desktop a{padding:.3rem;position:-webkit-sticky;position:sticky;top:90vh;display:flex;align-items:center;justify-content:center;color:#000;background-color:#fff;border-radius:8px;border:2px solid #000;box-shadow:2px 2px;width:2rem;height:2rem;line-height:2rem}.back-to-top-desktop a:hover{transform:scale(1.05)}::-webkit-scrollbar{width:22px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:var(--scrollbar-color);border:5px solid var(--base-color);border-radius:8px}::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,.25)}.right-section .column-page-content{padding-left:0;padding-right:30%}code[class*=language-],pre[class*=language-]{color:#d6deeb;font-family:Consolas,Monaco,"Andale Mono","Ubuntu Mono",monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;font-size:.9em;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::-moz-selection,code[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection{text-shadow:none;background:rgba(29,59,83,.99)}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:rgba(29,59,83,.99)}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:1.25em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{color:#fff;background:#011627;border-radius:4px}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.prolog{color:#637777;font-style:italic}.token.punctuation{color:#c792ea}.namespace{color:#b2ccd6}.token.deleted{color:rgba(239,83,80,.56);font-style:italic}.token.property,.token.symbol{color:#80cbc4}.token.keyword,.token.operator,.token.tag{color:#7fdbca}.token.boolean{color:#ff5874}.token.number{color:#f78c6c}.token.builtin,.token.char,.token.constant,.token.function{color:#82aaff}.token.doctype,.token.selector{color:#c792ea;font-style:italic}.token.attr-name,.token.inserted{color:#addb67;font-style:italic}.language-css .token.string,.style .token.string,.token.entity,.token.string,.token.url{color:#addb67}.token.atrule,.token.attr-value,.token.class-name{color:#ffcb8b}.token.important,.token.regex,.token.variable{color:#d6deeb}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}pre::-webkit-scrollbar-thumb{background:#6e6e6e;border:5px solid;border-radius:8px;border-color:#011627}pre::-webkit-scrollbar-thumb:hover{background:#969696}:root{--palette-offgray-100:#e2e5e9;--palette-offgray-200:#c0c5ce;--palette-offgray-300:#9da5b3;--palette-offgray-400:#7b8699;--palette-offgray-500:#4b5361;--palette-offgray-600:#1f293c;--palette-offwhite-100:#fcfcfa;--palette-offwhite-200:#dbd8d3;--palette-offwhite-300:#d0cabc;--palette-offwhite-400:#b6b39f;--palette-offwhite-500:#9c9686;--palette-offwhite-600:#5a574e;--palette-blue-100:#cdf;--palette-blue-200:#8fb5ff;--palette-blue-300:#6295f9;--palette-blue-400:#1d67f6;--palette-blue-500:#084ccf;--palette-blue-600:#053289;--palette-blue-700:#132b63;--palette-blue-800:#1a2742;--palette-purple-100:#f0e5ff;--palette-purple-200:#e2cbff;--palette-purple-300:#bb8dff;--palette-purple-400:#9d5fff;--palette-purple-500:#7013ff;--palette-purple-600:#4f00d8;--palette-purple-700:#360090;--palette-green-100:#d0f6e7;--palette-green-200:#8bdab9;--palette-green-300:#46be8c;--palette-green-400:#00a873;--palette-green-500:#007a50;--palette-green-600:#003d1f;--palette-teal-100:#dffffe;--palette-teal-200:#70f2f3;--palette-teal-300:#00e7e8;--palette-teal-400:#00cbc9;--palette-teal-500:#00999b;--palette-teal-600:#006567;--palette-yellow-100:#fff7d2;--palette-yellow-200:#fff1b6;--palette-yellow-300:#ffe674;--palette-yellow-400:#ffd912;--palette-yellow-500:#ffd000;--palette-yellow-600:#f29500;--palette-yellow-700:#b45800;--palette-yellow-800:#522d0d;--palette-red-100:#fed1ce;--palette-red-200:#fd978b;--palette-red-300:#fa6257;--image-border-radius:2px;--base-color:#fdfdfd;--accent-color:#ffd8b5;--scrollbar-color:rgba(0, 0, 0, 0.15);--content-size:800px;--link-hover-color:rgb(0, 0, 0);--highlighter-roundness:10px;--marker-roundness:10px;--green:130,255,173;--orange:255,218,98;--blue:79,155,255;--red:255,98,124;--yellow:255,234,71;--gray:rgba(60, 60, 60, 0.7)}</style><script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script><script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script><link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png"><link rel="manifest" href="/favicon/site.webmanifest"><link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="/favicon/favicon.ico"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/favicon/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" as="font" href="https://fonts.gstatic.com"><style>body,
  h1,
  h2,
  h3,
  h5 {
    font-family: 'Inter', serif;
  }</style><style>/* latin */
  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 700;
    font-display: swap;
    src: url("https://fonts.gstatic.com/s/inter/v3/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7.woff2") format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }</style><script rel="preconnect" data-goatcounter="https://ameye.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script></head><body class="fade-in"><style>:root {
        --marker-color: var(--yellow);
    }</style><header id="navbar-desktop" class="sticky py-100"><nav class="navbar-nav"><a href="/" aria-label="My notes." class="hover-highlight navbar-element" style="--highlighter-color: 185,231,236; --navbar-element-color: #0b85ff">/ notes</a> <a href="/projects" aria-label="My projects." class="hover-highlight navbar-element" style="--highlighter-color: 235, 204, 255; --navbar-element-color: #803fab">/ projects</a> <a href="/about" aria-label="About me." class="hover-highlight navbar-element" style="--highlighter-color: 255, 234, 71; --navbar-element-color: #f4ad43">/ about</a></nav></header><header id="navbar-mobile" class="sticky py-100"><nav class="navbar-nav"><a href="/" aria-label="All notes." class="hover-highlight navbar-element" style="--highlighter-color: 185,231,236; --navbar-element-color: #0b85ff">/ notes</a> <a href="/projects" aria-label="My projects." class="hover-highlight navbar-element" style="--highlighter-color: 235, 204, 255; --navbar-element-color: #803fab">/ projects</a> <a href="/about" aria-label="About me." class="hover-highlight navbar-element" style="--highlighter-color: 255, 234, 71; --navbar-element-color: #f4ad43">/ about</a></nav></header><div class="note column-page"><div class="note-content column-page-content"><h1 class="note-title">ðŸŒˆ Rendering realtime caustics</h1><div class="note-subtitle"><p>How to render realtime caustics in Unity.</p></div><div class="note-subtitle"><p class="reading-time"><b>9</b> minute read</p></div><h2 id="introduction" tabindex="-1"><a class="anchor-link" href="#introduction" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">#</span> </a>Introduction</h2><p>I will go over my method of rendering real-time <a href="https://en.wikipedia.org/wiki/Caustic_(optics)" target="_blank" rel="noopener noreferrer">caustics</a>. The goal is not to generate a physically accurate result, but rather to achieve <mark>real-time, controllable, good-looking</mark> water caustics effects.</p><video poster="reflections.png" preload="auto" width="75%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="realtime-caustics.webm" type="video/webm"></video><p>A good way of working with caustics is by creating <mark>caustics volumes</mark>. Essentially we create a volume, and position it where the caustics should show up in our scene.</p><h2 id="world-space-uvs" tabindex="-1"><a class="anchor-link" href="#world-space-uvs" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">#</span> </a>World-space UVs</h2><p>The caustics volume needs to render caustics onto the scene. For this, we will use a caustics texture. Since the caustics should be mapped to the geometry of the scene in world-space, we need to use <mark>world-space UVs</mark>. To get the world position, we will perform a reconstruction using the depth buffer. This is explained in the following sections.</p><h3 id="1.-reading-the-depth-buffer" tabindex="-1"><a class="anchor-link" href="#1.-reading-the-depth-buffer" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>1. Reading the depth buffer</h3><p>First we sample the depth buffer using screen-space coordinates.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">struct</span> <span class="token class-name">Attributes</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">float4</span> positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">struct</span> <span class="token class-name">Varyings</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">float4</span> positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br>Varyings <span class="token function">vert</span><span class="token punctuation">(</span>Attributes IN<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    Varyings OUT<span class="token punctuation">;</span><br>    OUT<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformObjectToHClip</span><span class="token punctuation">(</span>IN<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> OUT<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">half4</span> <span class="token function">frag</span><span class="token punctuation">(</span>Varyings IN<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target<br><span class="token punctuation">{</span><br>    <span class="token comment">// calculate position in screen-space coordinates</span><br>    <span class="token keyword">float2</span> positionNDC <span class="token operator">=</span> IN<span class="token punctuation">.</span>positionCS<span class="token punctuation">.</span>xy <span class="token operator">/</span> _ScaledScreenParams<span class="token punctuation">.</span>xy<span class="token punctuation">;</span><br><br>    <span class="token comment">// sample scene depth using screen-space coordinates</span><br>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_REVERSED_Z</span></span><br>    real depth <span class="token operator">=</span> <span class="token function">SampleSceneDepth</span><span class="token punctuation">(</span>positionNDC<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><br>        real depth <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span>UNITY_NEAR_CLIP_VALUE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">SampleSceneDepth</span><span class="token punctuation">(</span>UV<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><br><span class="token punctuation">}</span></code></pre><p>In the code above we simply sample the scene depth texture using normalized screen-space coordinates.</p><blockquote><p>ðŸ’¡ The UNITY_REVERSED_Z block is used to handle platform-specific differences related to the depth buffer.</p></blockquote><h3 id="2.-reconstructing-world-position-from-depth" tabindex="-1"><a class="anchor-link" href="#2.-reconstructing-world-position-from-depth" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>2. Reconstructing world position from depth</h3><p>Now that we have access to the value of the depth buffer given a screen-space coordinate, we can use it to compute a position in world-space coordinates using the following code in the fragment shader.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token comment">// calculate position in world-space coordinates</span><br><span class="token keyword">float3</span> positionWS <span class="token operator">=</span> <span class="token function">ComputeWorldSpacePosition</span><span class="token punctuation">(</span>positionNDC<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> UNITY_MATRIX_I_VP<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If we want, we can visualize this in the scene using the following code in the fragment shader, where we take the fractional part of the world-space position (you can leave it out in the final shader, it is just for debugging).</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half4</span> color <span class="token operator">=</span> <span class="token keyword">half4</span><span class="token punctuation">(</span><span class="token function">frac</span><span class="token punctuation">(</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">UNITY_REVERSED_Z</span></span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>depth <span class="token operator">&lt;</span> <span class="token number">0.0001</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">half4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><br>    <span class="token keyword">if</span><span class="token punctuation">(</span>depth <span class="token operator">></span> <span class="token number">0.9999</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">half4</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><br><span class="token keyword">return</span> color<span class="token punctuation">;</span></code></pre><p>As you can see, this gives us world-space positions to map our caustics texture to.</p><video poster="reflections.png" preload="auto" width="75%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="world-space-position.webm" type="video/webm"></video><h3 id="3.-caustics-volume" tabindex="-1"><a class="anchor-link" href="#3.-caustics-volume" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>3. Caustics volume</h3><p>We want the caustics volume to act like some sort of decal, where caustics show up wherever the volume intersects with the scene geometry. In order to achieve this, we calculate a <mark>bounding box mask in object space</mark> to limit the output of our shader.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token comment">// calculate position in object-space coordinates</span><br><span class="token keyword">float3</span> positionOS <span class="token operator">=</span> <span class="token function">TransformWorldToObject</span><span class="token punctuation">(</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// create bounding box mask</span><br><span class="token keyword">float</span> boundingBoxMask <span class="token operator">=</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token function">step</span><span class="token punctuation">(</span>positionOS<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token function">step</span><span class="token punctuation">(</span>positionOS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The way this bounding box mask works is by relying on the fact that the positions of the vertices of the box volume in object space, have a min/max of -0.5 and 0.5 respectively. We use a step function to mask out any pixels that are out of these bounds. The <mark>all</mark> function is used to make sure this happens in all of the x/y/z axes.</p><p>By multiplying our output with this bounding box mask, we can limit the caustics to only be rendered where needed.</p><figure><picture><source type="image/webp" srcset="bounding-box-mask.png-400w.webp 400w, bounding-box-mask.png-800w.webp 800w, bounding-box-mask.png-1098w.webp 1098w" sizes="(min-width: 30em) 50vw, 100vw"><source type="image/jpeg" srcset="bounding-box-mask.png-400w.jpeg 400w, bounding-box-mask.png-800w.jpeg 800w, bounding-box-mask.png-1098w.jpeg 1098w" sizes="(min-width: 30em) 50vw, 100vw"><img class="note-image" alt="Bounding box mask." style="width:;" loading="lazy" decoding="async" src="bounding-box-mask.png-400w.jpeg" width="1098" height="916"></picture><figcaption>Bounding box mask.</figcaption></figure><h2 id="caustics" tabindex="-1"><a class="anchor-link" href="#caustics" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">#</span> </a>Caustics</h2><p>We now have everything required to start displaying caustics. We will do this in multiple steps, each step improving on the effect.</p><h3 id="1.-mapping" tabindex="-1"><a class="anchor-link" href="#1.-mapping" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>1. Mapping</h3><p>We can map the caustics to the scene geometry by using the world-space coordinates as UVs. If you use the x and z components of the world-space position as UVs, the caustics will appear to be projected top-down onto the scene geometry. However, nstead of using a fixed direction, it would be better to let the direction of the light play a role in how the caustics are oriented.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half4x4</span> _MainLightDirection<span class="token punctuation">;</span><br><br><span class="token function">TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token function">SAMPLER</span><span class="token punctuation">(</span>sampler_CausticsTexture<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token comment">// calculate caustics texture UV coordinates (influenced by light direction)</span><br><span class="token keyword">half2</span> uv <span class="token operator">=</span> <span class="token function">mul</span><span class="token punctuation">(</span>positionWS<span class="token punctuation">,</span> _MainLightDirection<span class="token punctuation">)</span><span class="token punctuation">.</span>xy<span class="token punctuation">;</span><br><span class="token keyword">half4</span> caustics <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the code above, we use the main light direction to influence the UVs that we use to sample the caustics texture. By doing this, the caustics follow the direction of light and appear to be projected onto the scene.</p><figure><picture><source type="image/webp" srcset="mapping.png-400w.webp 400w, mapping.png-800w.webp 800w, mapping.png-980w.webp 980w" sizes="(min-width: 30em) 50vw, 100vw"><source type="image/jpeg" srcset="mapping.png-400w.jpeg 400w, mapping.png-800w.jpeg 800w, mapping.png-980w.jpeg 980w" sizes="(min-width: 30em) 50vw, 100vw"><img class="note-image" alt="Mapping caustics to the scene geometry." style="width:;" loading="lazy" decoding="async" src="mapping.png-400w.jpeg" width="980" height="790"></picture><figcaption>Mapping caustics to the scene geometry.</figcaption></figure><p>To be able to access the light direction in our shader, a C# script is used with the following code.</p><pre class="language-csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> sunMatrix <span class="token operator">=</span> RenderSettings<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localToWorldMatrix<span class="token punctuation">;</span><br>causticsMaterial<span class="token punctuation">.</span><span class="token function">SetMatrix</span><span class="token punctuation">(</span><span class="token string">"_MainLightDirection"</span><span class="token punctuation">,</span> sunMatrix<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This code will simply write the direction of the light to the appropriate shader property so that it can be used in the shader.</p><h3 id="2.-scaling-and-movement" tabindex="-1"><a class="anchor-link" href="#2.-scaling-and-movement" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>2. Scaling and movement</h3><p>Now that we have the caustics mapped to the scene geometry, let's get them moving. We can use a simple <mark>panner function</mark> to move the caustics texture. There is a parameter for controlling the speed, as well as the scale of the texture.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half2</span> <span class="token function">Panner</span><span class="token punctuation">(</span><span class="token keyword">half2</span> uv<span class="token punctuation">,</span> <span class="token keyword">half</span> speed<span class="token punctuation">,</span> <span class="token keyword">half</span> tiling<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">half2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> _Time<span class="token punctuation">.</span>y <span class="token operator">*</span> speed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>uv <span class="token operator">*</span> tiling<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">half2</span> moving_uv <span class="token operator">=</span> <span class="token function">Panner</span><span class="token punctuation">(</span>uv<span class="token punctuation">,</span> _CausticsSpeed<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> _CausticsScale<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>By using these modified UVs to sample the texture, we get moving caustics.</p><video poster="reflections.png" preload="auto" width="75%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="moving-caustics.webm" type="video/webm"></video><h3 id="3.-multiple-textures" tabindex="-1"><a class="anchor-link" href="#3.-multiple-textures" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>3. Multiple textures</h3><p>Having just a single caustics texture moving around looks kind of weird. To fix this, we will put a second caustics texture on top of the first one. The trick here is to move the textures with a different strength and scale.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token comment">// create panning UVs for the caustics</span><br><span class="token keyword">half2</span> uv1 <span class="token operator">=</span> <span class="token function">Panner</span><span class="token punctuation">(</span>uv<span class="token punctuation">,</span> <span class="token number">0.75</span> <span class="token operator">*</span> _CausticsSpeed<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> _CausticsScale<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">half2</span> uv2 <span class="token operator">=</span> <span class="token function">Panner</span><span class="token punctuation">(</span>uv<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> _CausticsSpeed<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">/</span> _CausticsScale<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">half4</span> tex1 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv1<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">half4</span> tex2 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv2<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">half3</span> caustics <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>tex1<span class="token punctuation">,</span> tex2<span class="token punctuation">)</span> <span class="token operator">*</span> _CausticsStrength<span class="token punctuation">;</span></code></pre><p>We combine the 2 moving textures using a <mark>min</mark> operation which will return the minimum of the inputs. We multiply the result with a strength parameter to control how bright the caustics appear.</p><video poster="reflections.png" preload="auto" width="75%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="moving-caustics-better.webm" type="video/webm"></video><p>In the code above, I use 1 single speed/scale parameter and use it for both textures by multiplying by some magic numbers, but you can of course expose the parameters so you have full control over it. The idea is just that the textures should have a different scale/speed and then the min operation will blend them.</p><h3 id="4.-chromatic-aberration" tabindex="-1"><a class="anchor-link" href="#4.-chromatic-aberration" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>4. Chromatic aberration</h3><p>In real life, the light rays passing through the water surface get refracted because a change of medium occurs from air to water. During this process, different wavelength components of the light get refracted under different angles, causing the light ray to fall out into a rainbow pattern. This looks really beautiful and we will try to mimic it in our caustics effect.</p><p>The idea is to create function that will sample the caustics texture 3 times, each time adding an offset to the UVs. We then use these 3 samples as our r/g/b components of the final result.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half3</span> <span class="token function">SampleCaustics</span><span class="token punctuation">(</span><span class="token keyword">half2</span> uv<span class="token punctuation">,</span> <span class="token keyword">half</span> split<span class="token punctuation">)</span><br><span class="token punctuation">{</span><br>    <span class="token keyword">half2</span> uv1 <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token keyword">half2</span><span class="token punctuation">(</span>split<span class="token punctuation">,</span> split<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">half2</span> uv2 <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token keyword">half2</span><span class="token punctuation">(</span>split<span class="token punctuation">,</span> <span class="token operator">-</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">half2</span> uv3 <span class="token operator">=</span> uv <span class="token operator">+</span> <span class="token keyword">half2</span><span class="token punctuation">(</span><span class="token operator">-</span>split<span class="token punctuation">,</span> <span class="token operator">-</span>split<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">half</span> r <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv1<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span><br>    <span class="token keyword">half</span> g <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv2<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span><br>    <span class="token keyword">half</span> b <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_CausticsTexture<span class="token punctuation">,</span> sampler_CausticsTexture<span class="token punctuation">,</span> uv3<span class="token punctuation">)</span><span class="token punctuation">.</span>r<span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> <span class="token keyword">half3</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token comment">// sample the caustics</span><br><span class="token keyword">half3</span> tex1 <span class="token operator">=</span> <span class="token function">SampleCaustics</span><span class="token punctuation">(</span>uv1<span class="token punctuation">,</span> _CausticsSplit<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">half3</span> tex2 <span class="token operator">=</span> <span class="token function">SampleCaustics</span><span class="token punctuation">(</span>uv2<span class="token punctuation">,</span> _CausticsSplit<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>I got the idea to generate chromatic aberration like this from <a href="https://www.alanzucconi.com/2019/09/13/believable-caustics-reflections/" target="_blank" rel="noopener noreferrer">this article</a> by Alan Zucconi.</p><video poster="reflections.png" preload="auto" width="75%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="chromatic-aberration.webm" type="video/webm"></video><h3 id="5.-luminance-mask" tabindex="-1"><a class="anchor-link" href="#5.-luminance-mask" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>5. Luminance mask</h3><p>Next, we will improve our caustics effect by masking the caustics based on the luminance in the scene. This will make it so that the caustics appear less prominent in shadowed areas.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token comment">// luminance mask</span><br><span class="token keyword">half3</span> sceneColor <span class="token operator">=</span> <span class="token function">SampleSceneColor</span><span class="token punctuation">(</span>positionNDC<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">half</span> sceneLuminance <span class="token operator">=</span> <span class="token function">Luminance</span><span class="token punctuation">(</span>sceneColor<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">half</span> luminanceMask <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> sceneLuminance<span class="token punctuation">,</span> _CausticsLuminanceMaskStrength<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The steps are simple. We sample the scene color, calculate the luminance, and then create a mask using a masking strength parameter.</p><video poster="reflections.png" preload="auto" width="75%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="luminance-mask.webm" type="video/webm"></video><p>Since the luminance value will almost never be zero, the caustics will still show up in shadowed areas, just less bright. If you really do not want caustics to show up there, you could work with a threshold value where caustics only show up if the luminance is over a certain value.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half</span> luminanceMask <span class="token operator">=</span> <span class="token function">smoothstep</span><span class="token punctuation">(</span>_CausticsLuminanceMaskStrength<span class="token punctuation">,</span> _CausticsLuminanceMaskStrength <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">,</span> sceneLuminance<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Another option is to sample the shadow map of the scene, and mask the caustics that way. This will result in hard cutoffs where the shadows are.</p><h3 id="6.-edge-fade" tabindex="-1"><a class="anchor-link" href="#6.-edge-fade" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>6. Edge fade</h3><p>Currently the caustics have a hard cutoff at the edge of the caustics volume. To make the transition a bit softer, we introduce a soft <mark>edge fade mask</mark>.</p><pre class="language-hlsl"><code class="language-hlsl"><span class="token keyword">half</span> edgeFadeMask <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">distance</span><span class="token punctuation">(</span>positionOS<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> _CausticsFadeRadius<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> _CausticsFadeStrength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>We can control the radius and the strength of the mask. Using this, the edges of the caustics volume look a bit less harsh.</p><video poster="reflections.png" preload="auto" width="75%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="edge-fade-mask.webm" type="video/webm"></video><h3 id="7.-underwater-camera" tabindex="-1"><a class="anchor-link" href="#7.-underwater-camera" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">##</span> </a>7. Underwater camera</h3><p>To allow the camera to go inside of the caustics volume, we apply a cool trick where we use <mark>Cull Front</mark> to not render the front-facing polygons of the volume mesh, but only the back-facing (inside) polygons. We also use <mark>ZTest Always</mark> to always render those back-faces, even if other scene geometry is blocking it.</p><pre class="language-hlsl"><code class="language-hlsl">Cull Front<br>ZTest Always</code></pre><p>This simple change allows the camera to enter the caustics volume without any problem.</p><video poster="reflections.png" preload="auto" width="50%" title="Shallow red." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="underwater-camera.webm" type="video/webm"></video><p>This approach was kindly explained to me by <a href="https://twitter.com/ABeginnersDevB1" target="_blank" rel="noopener noreferrer">A Beginner's Dev Blog</a>, <a href="https://twitter.com/harryh___h" target="_blank" rel="noopener noreferrer">Harry Heath</a>, <a href="https://twitter.com/RealtimeVFXMike" target="_blank" rel="noopener noreferrer">Mike V</a> and <a href="https://twitter.com/antonkudin" target="_blank" rel="noopener noreferrer">Anton Kudin</a> on Twitter, thanks!</p><h2 id="conclusion" tabindex="-1"><a class="anchor-link" href="#conclusion" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">#</span> </a>Conclusion</h2><p>And that's it! A nice looking caustics effect, as a result of many little techniques coming together.</p><video poster="reflections.png" preload="auto" width="75%" title="Rendering realtime caustics." loop="" autoplay="" playsinline="" muted="true" class="note-video"><source src="realtime-caustics.webm" type="video/webm"></video><p>You can get this shader including an additional volume system for easy placement on the Unity asset store. Any support would be greatly appreciated!</p><iframe src="https://assetstore.unity.com/linkmaker/embed/package/221106/widget-wide?aid=1101l20969" style="border:0px;"></iframe><h2 id="additional-resources" tabindex="-1"><a class="anchor-link" href="#additional-resources" target="_blank" rel="noopener noreferrer"><span class="screen-reader-only">Jump to heading</span> <span aria-hidden="true" class="anchor-symbol">#</span> </a>Additional resources</h2><p><a href="https://www.alanzucconi.com/2019/09/13/believable-caustics-reflections/" target="_blank" rel="noopener noreferrer">https://www.alanzucconi.com/2019/09/13/believable-caustics-reflections/</a></p><p><a href="https://twitter.com/flogelz/status/1165251296720576512?ref_src=twsrc%5Etfw" target="_blank" rel="noopener noreferrer">https://twitter.com/flogelz/status/1165251296720576512?ref_src=twsrc%5Etfw</a></p><div id="back-to-top-desktop" class="back-to-top-desktop"><a href="#" aria-label="Back to top of page."><span class="icon-arrow-up"></span></a></div><div id="back-to-top-mobile" class="back-to-top-mobile"><a href="#" aria-label="Back to top of page."><span class="icon-arrow-up"></span></a></div><div class="note-date">Published <time>March 2022</time></div></div><footer class="note-footer"><ul class="note-tags"><li><a style="--tag-bg: #e1f5f6; --tag-text: #0885ff;" href="/tags/graphics">graphics</a></li><li><a style="--tag-bg: #eafff3; --tag-text: #61b58e;" href="/tags/unity">unity</a></li><li><a style="--tag-bg: #fef9d3; --tag-text: #f4ad44;" href="/tags/gamedev">gamedev</a></li><li><a style="--tag-bg: #f9f0ff; --tag-text: #936bad;" href="/tags/tutorial">tutorial</a></li></ul></footer><div class="note-comments"><script src="https://giscus.app/client.js" data-repo="alexanderameye/alexanderameye.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkxMTM1NzkxODY=" data-category="Comments" data-category-id="DIC_kwDOBsUUss4CU3rh" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script></div></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous"></body></html>